#!groovy

//Use Shared libs
@Library('pipeline-libs@master') _

// This var controls the deployment and service name in k8s
env.SERVICE_NAME = 'pants'
// This is the project the private docker repo resides in in GCE.
env.REPO_NAME = 'gcr.io/sr-poc-message-delivery'

pipeline {
    agent any

    // Build the docker image using the Jenkins agent
    stages {
        stage('Build') {
            steps {
              // From shared libs. Assumes SERVICE_NAME and REPO_NAME exist.
              dockerBuild this
            }
        }
        // These stages handle the artifacts from the docker build etc.
        stage('Artifacts') {
          parallel {
            // Push to private docker repository
            stage('Push Image') {
                steps {
                    sh 'gcloud docker -- push $REPO_NAME/$SERVICE_NAME:$GIT_COMMIT'
                }
            }
            // Copy deployment file(s) to a private storage bucket
            stage('Copy deployment files') {
                steps {
                    sh 'ls'
                    sh 'gsutil cp deployment.yml Dockerfile gs://sr-deployment-artifacts/$SERVICE_NAME/$GIT_COMMIT/'
                    sh 'gsutil ls gs://sr-deployment-artifacts/$SERVICE_NAME/$GIT_COMMIT/'
                }
            }
          }
        }
        // Deploy the new build to the PANTS environment.
        stage('Deploy to Pants ENV') {
            steps {
                echo 'Deploying to pants'
                sh "sed -i.bak 's/\${build_number}/$GIT_COMMIT/g' deployment.yml"
                sh "sed -i.bak 's/\${image_name}/$SERVICE_NAME/g' deployment.yml"
                sh 'kubectl config use-context pants'
                sh 'kubectl apply --record=true -f deployment.yml'
                sh 'kubectl rollout status deployment $SERVICE_NAME'
            }
        }
        stage('Test') {
            steps {
                sh './tests/test.sh'
            }
        }
        // Manually deploy the build to the PANDA ENV. Will wait X time.
        stage('Deploy to Panda ENV') {
            steps {
                timeout(time: 1, unit: 'DAYS') {
                  input 'Are you sure?'
                }
                echo 'Deploying to panda'
                sh 'kubectl config use-context panda'
                sh 'kubectl apply --record=true -f deployment.yml'
                sh 'kubectl rollout status deployment $SERVICE_NAME'
            }
        }
    }
    post {
        always {
            archive 'tests/*.xml'
            junit 'tests/*.xml'
        }
    }
}
